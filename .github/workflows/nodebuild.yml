name: Build Android Node.js arm

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read  # workflow শুধু repo পড়বে, write দরকার নেই

env:
  SCCACHE_GHA_ENABLED: 'true'
  ANDROID_NDK_VERSION: r25b
  ANDROID_TARGET_SDK_VERSION: 25

jobs:
  build-android:
    runs-on: ubuntu-22.04

    strategy:
      fail-fast: false
      matrix:
        target_arch: [arm, arm64, x86_64]

    env:
      TARGET_ARCH: ${{ matrix.target_arch }}

    steps:
      # 1️⃣ Checkout repo
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2️⃣ SCCACHE caching
      - name: Run sccache-cache
        uses: mozilla-actions/sccache-action@v0.0.6

      # 3️⃣ Install build utils
      - name: Install build utils
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            gcc-multilib g++-multilib \
            git clang make cmake ninja-build \
            wget unzip curl pkg-config \
            python3.10 python3.10-venv

      # 4️⃣ Setup Android NDK
      - name: Setup Android NDK
        id: setup-ndk
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: ${{ env.ANDROID_NDK_VERSION }}
          add-to-path: false

      # 5️⃣ Build Node.js for Android
      - name: Build Node.js Android
        env:
          MY_ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}
          LDFLAGS: '-Wl,-z,max-page-size=16384'
        run: |
          ./tools/android_build.sh \
            $MY_ANDROID_NDK_HOME \
            $ANDROID_TARGET_SDK_VERSION \
            $TARGET_ARCH
          rm -rf out_android/libnode

      # 6️⃣ Upload architecture artifact
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: node-android-${{ matrix.target_arch }}
          path: out_android

  combine-android:
    runs-on: ubuntu-22.04
    needs: build-android

    steps:
      # 1️⃣ Checkout repo
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2️⃣ Install build utils
      - name: Install build utils
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            gcc-multilib g++-multilib \
            git clang make cmake ninja-build \
            wget unzip curl pkg-config \
            python3.10 python3.10-venv

      # 3️⃣ Setup Android NDK
      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: ${{ env.ANDROID_NDK_VERSION }}

      # 4️⃣ Download all Android build artifacts
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: node-android-*
          merge-multiple: true
          path: out_android

      - run: rm -rf out_android/libnode

      # 5️⃣ Generate config.gypi
      - name: Generate config.gypi
        run: ./configure

      # 6️⃣ Combine all Android builds
      - name: Combine Android binaries
        run: |
          mkdir -p artifacts/bin
          mkdir -p artifacts/include

          cp -R out_android/* artifacts/bin
          ./tools/copy_libnode_headers.sh android
          cp -R out_android/libnode/include/* artifacts/include

      # 7️⃣ Upload final combined artifact
      - name: Upload final artifact
        uses: actions/upload-artifact@v4
        with:
          name: nodejs-mobile-android
          path: artifacts

      # 8️⃣ Delete intermediate artifacts
      - name: Delete intermediate artifacts
        uses: geekyeggo/delete-artifact@v5
        with:
          name: node-android-*